<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDtools - Ultimate Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --bg: #050505; --panel: #0f0f0f; --accent: #a855f7; --text: #ffffff; --text-dim: #71717a; --border: #27272a; --bazinger: #ff3e3e; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: var(--panel); width: 95%; max-width: 1000px; margin: 20px 0; padding: 25px; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 3px; margin: 0 0 15px 0; font-size: 1.8rem; text-align: center; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full-width { grid-column: span 2; }
        button { background: #000; color: #fff; border: 1px solid var(--border); padding: 14px; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.2s; text-transform: uppercase; font-size: 0.85rem; }
        button:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
        input, select { background: #000; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 4px; width: 100%; box-sizing: border-box; outline: none; margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: var(--accent); margin-bottom: 5px; text-transform: uppercase; }
        .table-wrap { max-height: 500px; overflow-y: auto; border: 1px solid var(--border); background: #000; margin-top: 15px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; font-family: 'Consolas', monospace; text-align: center; }
        th { position: sticky; top: 0; background: #0a0a0a; color: var(--accent); padding: 12px; border-bottom: 1px solid var(--accent); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        .hidden { display: none !important; }
        .thanks-box { margin-top: 25px; text-align: center; font-size: 0.8rem; color: var(--text-dim); border-top: 1px solid var(--border); padding-top: 15px; }
        .thanks-box b { color: var(--bazinger); }
    </style>
</head>
<body>

<div id="main-menu" class="container">
    <h1>GDtools</h1>
    <div class="menu-grid">
        <button onclick="showPage('editor-page')">GMD Editor</button>
        <button onclick="showPage('gap-page')">Gap Calculator</button>
        <button onclick="showPage('finder-page')">Gap Finder</button>
        <button onclick="showPage('bazinger-page')" style="color: var(--bazinger); border-color: var(--bazinger);">Bazinger Calc</button>
        <button onclick="window.open('https://zcb3-web.vercel.app/', '_blank')">ZCB3 Web</button>
        <button onclick="window.open('https://conv.nattie.dev/', '_blank')">Macro Converter</button>
        <button class="full-width" onclick="showPage('wolfram-page')">WolframAlpha Solver</button>
    </div>
</div>

<div id="bazinger-page" class="container hidden">
    <h1 style="color: var(--bazinger);">Bazinger Calc</h1>
    <div style="max-width: 400px; margin: 0 auto;">
        <label>Введенные юниты</label>
        <input type="number" id="bazingerInput" step="0.0000000001" value="30.156097">
        <label>Для какой скорости?</label>
        <select id="bazingerSpeedSelect">
            <option value="0.5">0.5x</option>
            <option value="1.0" selected>1.0x</option>
            <option value="2.0">2.0x</option>
            <option value="3.0">3.0x</option>
            <option value="4.0">4.0x</option>
        </select>
        <button onclick="calculateBazingerTPS()" style="width: 100%; background: var(--bazinger); color: #000;">Рассчитать</button>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr><th>Speed</th><th>Target Units</th><th>TPS</th></tr>
            </thead>
            <tbody id="bazingerTable"></tbody>
        </table>
    </div>
    <div class="thanks-box">Special thanks to: <b>xvoloden</b></div>
    <button style="width:100%; margin-top:30px; background:#18181b" onclick="showPage('main-menu')">Назад</button>
</div>

<div id="finder-page" class="container hidden">
    <h1>Gap Finder</h1>
    <div style="max-width: 400px; margin: 0 auto;">
        <label>Целевой FPS</label><input type="number" id="targetFps" placeholder="360">
        <div style="margin-bottom: 15px;"><input type="checkbox" id="finderDash" style="width: auto; margin-right: 10px;"><label style="display: inline;">Dash Orb активен?</label></div>
        <button onclick="findGaps()" style="width: 100%; background: var(--accent); color: #000;">Рассчитать зазоры</button>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div><h3 style="text-align:center; color: var(--accent);">Big Wave</h3><div class="table-wrap"><table><thead><tr><th>Speed</th><th>Gap Size</th></tr></thead><tbody id="bigWaveTable"></tbody></table></div></div>
        <div><h3 style="text-align:center; color: var(--accent);">Mini Wave</h3><div class="table-wrap"><table><thead><tr><th>Speed</th><th>Gap Size</th></tr></thead><tbody id="miniWaveTable"></tbody></table></div></div>
    </div>
    <button style="width:100%; margin-top:30px; background:#18181b" onclick="showPage('main-menu')">Назад</button>
</div>

<div id="editor-page" class="container hidden">
    <h1>GMD Editor</h1>
    <div id="dropZone" style="border: 2px dashed #333; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('fileIn').click()">Загрузить .gmd файл<input type="file" id="fileIn" class="hidden" accept=".gmd" onchange="loadGMD(this)"></div>
    <div id="editor-ui" class="hidden">
        <label>Название</label><input type="text" id="lvlName">
        <button onclick="saveGMD()" style="width: 100%; background: var(--accent); color: #000; margin-bottom: 10px;">СОХРАНИТЬ .GMD</button>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>X</th><th>Y</th><th>Scale</th><th>Rot</th><th></th></tr></thead><tbody id="objList"></tbody></table></div>
    </div>
    <button style="width:100%; margin-top:15px; background:#18181b" onclick="showPage('main-menu')">Назад</button>
</div>

<div id="gap-page" class="container hidden">
    <h1>Gap Calculator</h1>
    <div style="max-width: 500px; margin: 0 auto;">
        <label>Размер гапа</label><input type="number" id="gapSize" step="0.0000000001" placeholder="3.12345">
        <label>Режим волны</label><select id="gapMode"><option value="normal">Обычная волна</option><option value="mini">Мини волна</option></select>
        <label>Скорость</label><select id="gapSpeed"><option value="0.5">0.5x Speed</option><option value="1" selected>1x Speed</option><option value="2">2x Speed</option><option value="3">3x Speed</option><option value="4">4x Speed</option></select>
        <div style="margin-bottom: 15px;"><input type="checkbox" id="gapDash" style="width: auto; margin-right: 10px;"><label style="display: inline;">Dash Orb активен?</label></div>
        <button onclick="calculatePreciseGap()" style="width: 100%; background: var(--accent); color: #000;">Рассчитать FPS</button>
        <div id="gapRes" style="text-align: center; font-size: 2rem; margin-top: 20px; color: var(--accent); font-weight: bold;"></div>
    </div>
    <button style="width:100%; margin-top:30px; background:#18181b" onclick="showPage('main-menu')">Назад</button>
</div>

<div id="wolfram-page" class="container hidden">
    <h1>WolframAlpha Solver</h1>
    <input type="text" id="wolfInput" placeholder="Введите запрос...">
    <button onclick="window.open('https://www.wolframalpha.com/input/?i='+encodeURIComponent(document.getElementById('wolfInput').value))" style="width:100%; background:var(--accent); color:#000">РЕШИТЬ</button>
    <button style="width:100%; margin-top:30px; background:#18181b" onclick="showPage('main-menu')">Назад</button>
</div>

<script>
    const b_speeds_keys = ["0.5", "1.0", "2.0", "3.0", "4.0"];
    const referenceGaps = {
        "0.5": 0.990097,
        "1.0": 0.156097,
        "2.0": 0.364403,
        "3.0": 0.585800,
        "4.0": 0.882600
    };

    function showPage(id) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function calculateBazingerTPS() {
        const inputVal = parseFloat(document.getElementById('bazingerInput').value);
        const selectedSpeed = document.getElementById('bazingerSpeedSelect').value;
        if (!inputVal || inputVal <= 30) return alert("Введите значение > 30");

        const userGap = inputVal - 30;
        const difficultyMultiplier = referenceGaps[selectedSpeed] / userGap;
        const targetTPS = 1000 * difficultyMultiplier;

        const tbody = document.getElementById('bazingerTable');
        tbody.innerHTML = "";

        b_speeds_keys.forEach(speed => {
            const calculatedGap = referenceGaps[speed] / difficultyMultiplier;
            const finalUnits = 30 + calculatedGap;

            tbody.innerHTML += `
                <tr>
                    <td>${speed}x</td>
                    <td style="color:${speed === selectedSpeed ? 'var(--accent)' : 'var(--bazinger)'}; font-weight:bold;">
                        ${finalUnits.toFixed(8)}
                    </td>
                    <td>${Math.round(targetTPS).toLocaleString()}</td>
                </tr>
            `;
        });
    }

    const constants = {
        normal: { "0.5": 251.159363, "1": 311.579742, "2": 387.421265, "3": 468.001038, "4": 575.999756 },
        mini: { "0.5": 502.321411, "1": 623.161926, "2": 774.843140, "3": 936.003967, "4": 1152.005615 }
    };

    function findGaps() {
        let fps = parseFloat(document.getElementById('targetFps').value);
        if (!fps) return;
        if (document.getElementById('finderDash').checked) fps *= 2;
        const fill = (id, m) => {
            const b = document.getElementById(id); b.innerHTML = "";
            Object.keys(constants[m]).forEach(s => {
                const g = (constants[m][s] / fps) + 3;
                b.innerHTML += `<tr><td>${s}x</td><td>${g.toFixed(10)}</td></tr>`;
            });
        };
        fill("bigWaveTable", "normal"); fill("miniWaveTable", "mini");
    }

    function calculatePreciseGap() {
        const gap = parseFloat(document.getElementById('gapSize').value);
        const k = constants[document.getElementById('gapMode').value][document.getElementById('gapSpeed').value];
        let fps = k / (gap - 3);
        if (document.getElementById('gapDash').checked) fps *= 2;
        document.getElementById('gapRes').innerText = Math.round(fps).toLocaleString() + " FPS";
    }

    let currentObjects = []; let originalDoc = null;
    async function loadGMD(input) {
        const file = input.files[0]; if (!file) return;
        const text = await file.text();
        originalDoc = new DOMParser().parseFromString(text, "text/xml");
        const k4 = Array.from(originalDoc.getElementsByTagName('k')).find(x => x.textContent === 'k4');
        const k2 = Array.from(originalDoc.getElementsByTagName('k')).find(x => x.textContent === 'k2');
        if(k2) document.getElementById('lvlName').value = k2.nextElementSibling.textContent;
        const bin = atob(k4.nextElementSibling.textContent.replace(/-/g, '+').replace(/_/g, '/'));
        const bytes = pako.inflate(new Uint8Array(bin.split('').map(c => c.charCodeAt(0))), { to: 'string' });
        currentObjects = bytes.split(';').filter(s => s.length > 5).map(s => {
            const d = {}; s.split(',').forEach((v, i, a) => { if(i%2===0) d[v] = a[i+1]; }); return d;
        });
        document.getElementById('editor-ui').classList.remove('hidden');
        document.getElementById('dropZone').classList.add('hidden');
        renderObjects();
    }

    function renderObjects() {
        document.getElementById('objList').innerHTML = currentObjects.slice(0, 100).map((obj, idx) => `
            <tr>
                <td><input type="text" value="${obj['1']}" onchange="currentObjects[${idx}]['1']=this.value"></td>
                <td><input type="text" value="${obj['2']}" onchange="currentObjects[${idx}]['2']=this.value"></td>
                <td><input type="text" value="${obj['3']}" onchange="currentObjects[${idx}]['3']=this.value"></td>
                <td><input type="text" value="${obj['128'] || 1}" onchange="currentObjects[${idx}]['128']=this.value"></td>
                <td><input type="text" value="${obj['6'] || 0}" onchange="currentObjects[${idx}]['6']=this.value"></td>
                <td><button onclick="currentObjects.splice(${idx},1);renderObjects()" style="color:red;border:none;background:none;">✕</button></td>
            </tr>
        `).join('');
    }

    function saveGMD() {
        const objStr = currentObjects.map(o => Object.entries(o).map(e => e.join(',')).join(',')).join(';') + ';';
        const b64 = btoa(String.fromCharCode.apply(null, pako.deflate(objStr))).replace(/\+/g, '-').replace(/\//g, '_');
        const k4 = Array.from(originalDoc.getElementsByTagName('k')).find(x => x.textContent === 'k4');
        if(k4) k4.nextElementSibling.textContent = b64;
        const xml = '<?xml version="1.0"?><plist version="1.0" gjver="2.0">' + originalDoc.documentElement.innerHTML + '</plist>';
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([xml], {type: "application/octet-stream"}));
        a.download = (document.getElementById('lvlName').value || "level") + ".gmd"; a.click();
    }
</script>
</body>
</html>
