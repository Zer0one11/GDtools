<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDtools - Level Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --bg: #050505; --panel: #0f0f0f; --accent: #a855f7; --text: #ffffff; --text-dim: #71717a; --border: #27272a; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: var(--panel); width: 95%; max-width: 1000px; margin: 20px 0; padding: 25px; border: 1px solid var(--border); border-radius: 8px; }
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 3px; margin: 0; font-size: 1.8rem; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        button { background: #000; color: #fff; border: 1px solid var(--border); padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        button:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); }
        .file-zone { border: 2px dashed var(--border); padding: 30px; text-align: center; color: var(--text-dim); cursor: pointer; margin-bottom: 20px; }
        .editor-header { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        input, select { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .table-wrap { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); background: #000; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; font-family: monospace; }
        th { position: sticky; top: 0; background: #0a0a0a; color: var(--accent); padding: 10px; border-bottom: 1px solid var(--accent); }
        td { padding: 5px 10px; border-bottom: 1px solid var(--border); }
        .footer { margin-top: auto; padding: 20px; text-align: center; font-size: 0.8rem; color: var(--text-dim); }
        .footer strong { color: var(--accent); }
        .hidden { display: none; }
        .search-box { margin-bottom: 10px; border-color: var(--accent); }
        .modal { background: rgba(0,0,0,0.9); position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    </style>
</head>
<body>

<div id="main-menu" class="container">
    <h1>GDtools</h1>
    <div class="menu-grid">
        <button onclick="showPage('editor-page')">GMD Editor / Checker</button>
        <button onclick="showPage('gap-page')">Gap Calculator</button>
    </div>
    <button style="width:100%" onclick="showHelp()">–ò–ù–°–¢–†–£–ö–¶–ò–Ø (ID –û–ë–™–ï–ö–¢–û–í)</button>
</div>

<div id="editor-page" class="container hidden">
    <h1>GMD Editor</h1>
    <div class="file-zone" id="dropZone" onclick="document.getElementById('fileIn').click()">
        –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ .gmd —Ñ–∞–π–ª–∞
        <input type="file" id="fileIn" class="hidden" accept=".gmd" onchange="loadGMD(this)">
    </div>

    <div id="edit-controls" class="hidden">
        <div class="editor-header">
            <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" id="lvlName"></div>
            <div><label>–û–ø–∏—Å–∞–Ω–∏–µ:</label><input type="text" id="lvlDesc"></div>
        </div>

        <input type="text" id="objSearch" class="search-box" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º..." oninput="renderObjects()">
        
        <button onclick="addObject()" style="background: #1a2e1a; border-color: #22c55e; margin-bottom: 10px;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>X</th><th>Y</th><th>Scale</th><th>Rot</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="objList"></tbody>
            </table>
        </div>

        <button onclick="saveGMD()" style="width:100%; background: var(--accent); color: #000; font-size: 1.1rem;">–°–û–•–†–ê–ù–ò–¢–¨ –§–ê–ô–õ (.GMD)</button>
    </div>
    <button style="width:100%; margin-top:10px; background:#18181b" onclick="location.reload()">–ù–∞–∑–∞–¥</button>
</div>

<div id="gap-page" class="container hidden">
    <h1>Gap Calculator</h1>
    <button style="width:100%; margin-top:20px;" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div class="footer">
    GDtools | –ê–≤—Ç–æ—Ä: <strong>HELFZz</strong><br>
    Special Thanks:
</div>

<div id="helpModal" class="modal hidden" onclick="this.classList.add('hidden')">
    <div class="container" style="max-width: 500px;">
        <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
        <p>–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å ID –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —Å–∫–∞—á–∞–π—Ç–µ –º–æ–¥ <strong>Better Object Info</strong> –≤ Geode, –∑–∞–π–¥–∏—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –≤—ã–¥–µ–ª–∏—Ç–µ –Ω—É–∂–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ID.</p>
        <button style="width:100%" onclick="document.getElementById('helpModal').classList.add('hidden')">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    let currentObjects = [];
    let originalXML = null;

    function showPage(id) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showHelp() { document.getElementById('helpModal').classList.remove('hidden'); }

    async function loadGMD(input) {
        const file = input.files[0];
        if (!file) return;
        const text = await file.text();
        const parser = new DOMParser();
        originalXML = parser.parseFromString(text, "text/xml");

        const getVal = (k) => {
            const el = Array.from(originalXML.getElementsByTagName('k')).find(x => x.textContent === k);
            return el ? el.nextElementSibling.textContent : "";
        };

        document.getElementById('lvlName').value = getVal('k2');
        document.getElementById('lvlDesc').value = getVal('k3');

        const k4 = getVal('k4');
        if (k4) {
            const bin = atob(k4.replace(/-/g, '+').replace(/_/g, '/'));
            const bytes = pako.inflate(new Uint8Array(bin.split('').map(c => c.charCodeAt(0))), { to: 'string' });
            currentObjects = bytes.split(';').filter(s => s.length > 5).map(s => {
                const p = s.split(',');
                const d = {};
                for(let i=0; i<p.length; i+=2) d[p[i]] = p[i+1];
                return d;
            });
            document.getElementById('edit-controls').classList.remove('hidden');
            document.getElementById('dropZone').classList.add('hidden');
            renderObjects();
        }
    }

    function renderObjects() {
        const query = document.getElementById('objSearch').value.toLowerCase();
        const list = document.getElementById('objList');
        list.innerHTML = "";

        currentObjects.forEach((obj, idx) => {
            if (query && !JSON.stringify(obj).toLowerCase().includes(query)) return;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${obj['1']}" onchange="updateObj(${idx}, '1', this.value)"></td>
                <td><input type="text" value="${obj['2']}" onchange="updateObj(${idx}, '2', this.value)"></td>
                <td><input type="text" value="${obj['3']}" onchange="updateObj(${idx}, '3', this.value)"></td>
                <td><input type="text" value="${obj['128'] || '1'}" onchange="updateObj(${idx}, '128', this.value)"></td>
                <td><input type="text" value="${obj['6'] || '0'}" onchange="updateObj(${idx}, '6', this.value)"></td>
                <td>
                    <button onclick="alert('Raw Data: '+JSON.stringify(currentObjects[${idx}]))">üëÅÔ∏è</button>
                    <button onclick="removeObj(${idx})" style="color:#ef4444">X</button>
                </td>
            `;
            list.appendChild(row);
        });
    }

    function updateObj(idx, key, val) { currentObjects[idx][key] = val; }
    function removeObj(idx) { currentObjects.splice(idx, 1); renderObjects(); }
    function addObject() { currentObjects.push({"1":"1","2":"0","3":"0"}); renderObjects(); }

    function saveGMD() {
        // –°–±–æ—Ä–∫–∞ —Å—Ç—Ä–æ–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤
        const objStr = currentObjects.map(obj => Object.entries(obj).map(e => e.join(',')).join(',')).join(';') + ';';
        const compressed = pako.deflate(objStr);
        const b64 = btoa(String.fromCharCode.apply(null, compressed)).replace(/\+/g, '-').replace(/\//g, '_');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ XML
        const setVal = (k, newVal) => {
            const el = Array.from(originalXML.getElementsByTagName('k')).find(x => x.textContent === k);
            if(el) el.nextElementSibling.textContent = newVal;
        };

        setVal('k2', document.getElementById('lvlName').value);
        setVal('k3', document.getElementById('lvlDesc').value);
        setVal('k4', b64);

        const blob = new Blob([new XMLSerializer().serializeToString(originalXML)], {type: "text/xml"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = document.getElementById('lvlName').value + ".gmd";
        link.click();
    }
</script>
</body>
</html>
