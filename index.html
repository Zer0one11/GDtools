<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDtools - GMD Checker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --panel: #0f0f0f;
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.4);
            --text: #ffffff;
            --text-dim: #71717a;
            --border: #27272a;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background: var(--panel);
            width: 95%;
            max-width: 900px;
            margin: 40px 0;
            padding: 30px;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 {
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin: 0;
            font-size: 2rem;
            text-shadow: 0 0 20px var(--accent-glow);
        }

        .author-box {
            margin-bottom: 24px;
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .author-box strong { color: var(--accent); }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        button {
            background: #000;
            color: #fff;
            border: 1px solid var(--border);
            padding: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
        }

        button:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: translateY(-1px);
        }

        .file-zone {
            border: 2px dashed var(--border);
            padding: 60px 20px;
            text-align: center;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: 0.3s;
        }

        .file-zone:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.05);
            color: var(--text);
        }

        .table-wrap {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.8rem;
        }

        th {
            position: sticky; top: 0;
            background: #0a0a0a;
            color: var(--accent);
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--accent);
            z-index: 10;
        }

        td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: #d1d1d6; }
        tr:hover { background: rgba(168, 85, 247, 0.1); }

        .hidden { display: none; }
        .stats { color: var(--accent); font-size: 0.85rem; margin-bottom: 8px; font-family: monospace; }
        
        input[type="number"], select {
            width: 100%; padding: 12px;
            background: #09090b; border: 1px solid var(--border);
            color: white; margin: 8px 0; border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="main-menu" class="container">
    <h1>GDtools</h1>
    <div class="author-box">
        By <strong>HELFZz</strong> | Special Thanks: 
    </div>
    <div class="menu-grid">
        <button onclick="showPage('checker-page')">GMD Checker</button>
        <button onclick="showPage('gap-page')">Gap Calculator</button>
    </div>
</div>

<div id="checker-page" class="container hidden">
    <h1>GMD Checker</h1>
    <div class="author-box">Object Data Extractor</div>
    
    <div class="file-zone" onclick="document.getElementById('fileInput').click()">
        Загрузите .gmd файл для анализа каждого блока
        <input type="file" id="fileInput" class="hidden" accept=".gmd" onchange="processFile(this)">
    </div>

    <div id="file-info" class="stats"></div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>OBJ ID</th>
                    <th>X POS</th>
                    <th>Y POS</th>
                    <th>SCALE</th>
                    <th>ROT</th>
                </tr>
            </thead>
            <tbody id="obj-list">
                <tr><td colspan="5" style="text-align:center; color:#3f3f46;">Ожидание файла...</td></tr>
            </tbody>
        </table>
    </div>
    
    <button style="width:100%; margin-top:24px; background: #18181b;" onclick="showPage('main-menu')">Назад</button>
</div>

<div id="gap-page" class="container hidden">
    <h1>Gap Calculator</h1>
    <div class="author-box">Calculations</div>
    <input type="number" id="gapSize" placeholder="Gap size (e.g. 3.0001)">
    <select id="mode">
        <option value="3">Big Wave (3.0)</option>
        <option value="6">Mini Wave (6.0)</option>
    </select>
    <select id="speed">
        <option value="1">1x Speed</option>
        <option value="0.5">0.5x Speed</option>
        <option value="2">2x Speed</option>
        <option value="3">3x Speed</option>
        <option value="4">4x Speed</option>
    </select>
    <div style="margin: 12px 0; font-size: 0.9rem;">
        <input type="checkbox" id="dash"> <label for="dash">With Dash Orb (*2 FPS)</label>
    </div>
    <button onclick="calcGap()" style="width: 100%;">Calculate</button>
    <div id="res" style="margin-top:20px; color:var(--accent); font-weight:800; font-size: 1.2rem;"></div>
    <button style="width:100%; margin-top:24px; background: #18181b;" onclick="showPage('main-menu')">Назад</button>
</div>

<script>
    function showPage(id) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    async function processFile(input) {
        const file = input.files[0];
        if (!file) return;

        const text = await file.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        // Универсальный поиск k4 и k2 через обход всех узлов
        let levelName = "Unnamed";
        let k4Data = "";

        const keys = xml.getElementsByTagName('k');
        for (let i = 0; i < keys.length; i++) {
            if (keys[i].textContent === 'k2') levelName = keys[i].nextElementSibling.textContent;
            if (keys[i].textContent === 'k4') k4Data = keys[i].nextElementSibling.textContent;
        }

        if (!k4Data) {
            alert("Ошибка: Данные k4 не найдены. Убедитесь, что это корректный .gmd файл.");
            return;
        }

        document.getElementById('file-info').innerText = "LEVEL: " + levelName.toUpperCase();

        try {
            // GD Base64 -> Gzip
            const b64 = k4Data.replace(/-/g, '+').replace(/_/g, '/');
            const bin = atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            
            const raw = pako.inflate(bytes, { to: 'string' });
            const objects = raw.split(';');
            
            const list = document.getElementById('obj-list');
            list.innerHTML = "";

            // Парсим объекты
            objects.forEach((objStr, index) => {
                if (objStr.length < 5) return;
                const p = objStr.split(',');
                const d = {};
                for (let j = 0; j < p.length; j += 2) d[p[j]] = p[j+1];

                // Выводим данные: ID (1), X (2), Y (3), Scale (128), Rotation (6)
                list.insertAdjacentHTML('beforeend', `<tr>
                    <td>${d['1'] || '?'}</td>
                    <td>${parseFloat(d['2'] || 0).toFixed(2)}</td>
                    <td>${parseFloat(d['3'] || 0).toFixed(2)}</td>
                    <td>${d['128'] || d['32'] || '1'}</td>
                    <td>${d['6'] || '0'}°</td>
                </tr>`);
            });
            
            document.getElementById('file-info').innerText += ` | OBJECTS: ${objects.length - 1}`;
        } catch (e) {
            alert("Ошибка декодирования k4: " + e.message);
        }
    }

    function calcGap() {
        const gap = parseFloat(document.getElementById('gapSize').value);
        if (!gap) return;
        const speedMap = { "0.5": 0.75, "1": 0.9, "2": 1.1, "3": 1.35, "4": 1.65 };
        let fps = (speedMap[document.getElementById('speed').value] * 450000) / Math.abs(gap - 3);
        if (document.getElementById('dash').checked) fps *= 2;
        document.getElementById('res').innerText = "FPS: " + Math.round(fps).toLocaleString();
    }
</script>
</body>
</html>
